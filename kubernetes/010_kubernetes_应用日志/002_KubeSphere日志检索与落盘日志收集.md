## KubeSphere日志检索与落盘日志收集



### 1 日志检索

安装完成后可以在KubeSphere平台, 登录之后再页面的右下角的工具箱内点击 `容器日志查询`

可以看到日志数量的直方图

可以根据 关键字 / 项目 / 工作负载 / 容器组 / 容器 / 时间范围 搜索日志

可以输入多个条件来缩小搜索结果

比如根据 关键字: error 项目: test 时间范围:最近12小时 来进行搜索

点击搜索结果的直方图可以进入该时间范围的日志



### 2 落盘日志收集

1 以project-admin身份账号登录KubeSphere平台, 进入项目

2 在左侧导航栏中,选择`项目设置-日志收集`, 点击 启动开关切换至 `已启用`

3 在左侧导航栏中, 选择 `应用负载-工作负载-部署` 选项卡下点击`创建`

4 在弹窗中输入部署基本信息, 设置部署名称, 如 `demo-deployment` ,点击下一步

5 在容器组设置中点击添加容器

6 在搜索框中输入 `alpine` ,默认使用 latest 版本即可, 等价于 `alpine:latest`

7 向下滚动找到`启动命令`,勾选,在命令行和参数中分别输入

运行命令

```bash
/bin/sh
```

参数

```bash
-c,if [ ! -d "/data/log" ]; then mkdir -p /data/log; fi; while true; do date >> /data/log/app-test.log; sleep 5; done
```

指令格式就是

```bash
if [ ! -d "/data/log" ]; then
    mkdir -p /data/log
fi

while true; do
    date >> /data/log/app-test.log
    sleep 5
done
```



8 在存储设置选项卡切换启动 `收集存储卷上日志`

9 点击挂载存储卷, 在临时存储卷选项卡下, 输入存储卷名称 ( 如: `pv-log-test` ) ,并设置

访问模式 `读写` 

挂载路径: `/data/log` 

容器日志路径: `*.log`

点击√ 点击下一步



10 其他按照默认设置,点击 `下一步` / `创建` 完成创建



这样示例部署就创建好了, 这个示例部署 demo-deployment 中创建了一个 pod , 里面运行了容器 alpine 系统, 每5秒输出日志到 /data/log/app-test.log 中

点击页面右下角工具箱, 点击`容器日志查询`, 在搜索框中选择 `工作负载` 输入 demo-deployment 就可以查询到刚创建的pod中输出的日志了

点击搜索结果列表中的任意一条,会进入日志详情页, 在日志详情页中点击右上角的播放键可以刷新日志, 可以在右边的下拉框中选择`刷新频率` ,更新了刷新频率后要重新开启日志刷新, 刷新频率设置才能生效, 右边还有按钮可以导出日志









