## KubeSphere平台上应用的灰度发布

https://www.kubesphere.io/zh/docs/v3.3/project-user-guide/grayscale-release/overview/



## 1 灰度发布策略

当您在 KubeSphere 中升级应用至新版本时，灰度发布可以确保平稳过渡。采用的具体策略可能不同，但最终目标相同，即提前识别潜在问题，避免影响在生产环境中运行的应用。这样不仅可以将版本升级的风险降到最低，还能测试应用新构建版本的性能。

KubeSphere 为用户提供三种灰度发布策略。



### 1.1 蓝绿部署

蓝绿部署会创建一个相同的备用环境，在该环境中运行新的应用版本，从而为发布新版本提供一个高效的方式，不会出现宕机或者服务中断。通过这种方法，KubeSphere 将所有流量路由至其中一个版本，即在任意给定时间只有一个环境接收流量。如果新构建版本出现任何问题，您可以立刻回滚至先前版本。



### 1.2 金丝雀发布

金丝雀部署缓慢地向一小部分用户推送变更，从而将版本升级的风险降到最低。具体来讲，您可以在高度响应的仪表板上进行定义，选择将新的应用版本暴露给一部分生产流量。另外，您执行金丝雀部署后，KubeSphere 会监控请求，为您提供实时流量的可视化视图。在整个过程中，您可以分析新的应用版本的行为，选择逐渐增加向它发送的流量比例。待您对构建版本有把握后，便可以把所有流量路由至该构建版本。

使用金丝雀发布有2种策略

1 流量匹配策略

使一小部分流量转到新版本中, 当新版本稳定运行时, 逐渐扩大新版本流量比例



2 用户匹配策略

配置一定的匹配规则, 选择一定的测试用户或者主动参与的体验用户, 只有匹配的用户才转向新的服务. 这样可以提升用户体验, 降低升级的风险 . 



### 1.3 流量镜像

流量镜像复制实时生产流量并发送至镜像服务。默认情况下，KubeSphere 会镜像所有流量，您也可以指定一个值来手动定义镜像流量的百分比。常见用例包括：

1 测试新的应用版本。您可以对比镜像流量和生产流量的实时输出。

2 测试集群。您可以将实例的生产流量用于集群测试。

3 测试数据库。您可以使用空数据库来存储和加载数据。

镜像流量返回的结果不会返回给用户





## 2 金丝雀发布

在KubeSphere平台上, 进入测试项目的项目空间, 在 应用负载-应用-自制应用 页面, 点击 `部署示例应用`

基本信息

```bash
名称: bookinfo
版本: v1
应用治理: 启用
描述
```

点击 下一步 

服务

```bash
productpage
无状态服务

reviews
无状态服务

details
无状态服务

ratings
无状态服务
```

可以点击编辑查看各个服务的详细信息, 这里不做修改, 点击 下一步

路由规则

点击添加路由规则

| 域名                          | 协议 | 路径 | 服务        | 端口 |
| ----------------------------- | ---- | ---- | ----------- | ---- |
| productpage.bookinfo.test.com | HTTP | /    | productpage | 9080 |
|                               |      |      |             |      |
|                               |      |      |             |      |
|                               |      |      |             |      |

点击创建 稍等一段时间就会自动创建完成



在项目空间 应用负载-应用-自制应用 的应用列表中点击新创建的 bookinfo ,进入应用详情页, 点击右边的 访问服务

就可以访问页面了:



在应用详情的上面点击`灰度发布`, 创建 `灰度发布任务` 

`发布模式`

在 `金丝雀发布` 中点击 `创建`



创建金丝雀发布任务

基本信息

名称: review-v2

下一步



服务设置

在 reviews 服务上点击`选择`

点击下一步



新版本设置

当前版本 

新版本号: V2

镜像:  kubesphere/example-bookinfo-reviews-v2:1.16.2



点击下一步

指定流量分配

调整v2版本接收的流量, 先设定为20%

点击创建



任务就创建完成了, 在`灰度发布 - 任务状态`中可以看到刚创建的金丝雀发布任务, 但是此时还没有显示任务流量

在浏览器中打开项目的页面  http://productpage.bookinfo.test.com:30140/  , 连续刷新几次, 就可以看到v2版本页面

在服务器节点中使用 watch 命令

```
watch -n 1 curl  http://productpage.bookinfo.test.com:30140/
```



在任务状态列表中点击 review-v2 进入发布任务详情页, 可以在这个页面看到 reviews 服务的流量比例, 目前 v2 版本流量比例为 20% , 可以在 `流量分配` 中控制不同版本的流量比例, 



将 v2 版本的流量的比例扩大到 80% , 在弹窗中点击确定



在流量监控页面可以看到流量的网络图, 可以看到 reviews-v2 调用了 rating-v1 服务



继续创建灰度发布

创建灰度发布任务

发布模式

选择金丝雀部署, 点击创建

创建金丝雀发布任务

基本信息

名称: reviews-v3

点击下一步



服务设置:

在 reviews 上点击选择

点击下一步



新版本设置

新版本号: v3

镜像: kubesphere/example-bookinfo-reviews-v3:1.16.2

点击下一步



策略设置

选择 指定请求参数

当前页面有4种匹配方式

Cookie

Header

URL

操作系统



可以设置一个或者多个条件进行匹配, 其中客户端操作系统是一个预制的 header匹配, 通过 User-Agent 字段判断是否包含操作系统信息



经过测试后可以在发布任务详情页中的 版本 中选择新版本或者 旧版本 点击菜单中的 接管 , 使得这个版本的服务接管所有的流量





































