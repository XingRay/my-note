## KubeSphere应用部署-elasticsearch



### 查找elasticsearch镜像

https://hub.docker.com/_/elasticsearch

首先在dockerhub搜索es镜像， 在镜像描述中会有镜像的核心特点，如配置文件的位置，数据存储的位置，环境变量等。参考官方镜像的文档，典型的docker启动es命令：

```bash
# 创建数据目录
mkdir -p /mydata/es-01 && chmod 777 -R /mydata/es-01

# 容器启动
docker run --restart=always -d -p 9200:9200 -p 9300:9300 \
-e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
-v es-config:/usr/share/elasticsearch/config \
-v /mydata/es-01/data:/usr/share/elasticsearch/data \
--name es-01 \
elasticsearch:8.8.1
```

注意：es的容器内部的配置文件目录为 /usr/share/elasticsearch/config，该目录有多个配置文件，但是需要挂载到外部进行修改的只有 `elasticsearch.yml` 和 `jvm.options`。使用docker启动es的时候，`/usr/share/elasticsearch/config` 挂载方式是是使用数据卷挂载，而不是目录挂载， 使用目录挂载会使得容器内部所有的配置文件被覆盖， 只会保存挂载在外部的配置文件，也就是只会保留 elasticsearch.yml 和 jvm.options 两个文件。但是使用数据卷挂载就不会有这个问题，使用数据卷挂载，会保留容器内的其他的配置文件。但是k8s创建数据卷声明模板的时候需要特殊处理。es容器文件挂载有：

```bash
-v es-config:/usr/share/elasticsearch/config \
-v /mydata/es-01/data:/usr/share/elasticsearch/data \
```

将容器内部的2个目录挂载到了容器的外部。挂载 /usr/share/elasticsearch/data目录到pvc， 配置ConfigMap，映射到容器内 /usr/share/elasticsearch/config 目录下。key为 elasticsearch.yml 和 jvm.options



#### 创建配置：

点击 `配置-配置字典` ，点击创建，在弹出的窗口中设置：

```bash
名称: elasticsearch-standalone-config
别名: project-test-elasticsearch-standalone-config
描述: 测试项目elasticsearch单节点服务配置
```

点击`下一步` 进入`数据设置`，点击 `添加数据`，这里添加数据需要设置key-value，注意es的配置文件为 `/usr/share/elasticsearch/config`目录下的 `elasticsearch.yml`和  `jvm.options` 。



##### 添加 `elasticsearch.yml` 

点击添加数据 ，key就是配置文件的文件名 `elasticsearch.yml` , value 基于官方配置文件 `elasticsearch.yml` 修改后的内容，可以添加下列的配置：

```yaml
# ======================== Elasticsearch Configuration =========================
#
# NOTE: Elasticsearch comes with reasonable defaults for most settings.
#       Before you set out to tweak and tune the configuration, make sure you
#       understand what are you trying to accomplish and the consequences.
#
# The primary way of configuring a node is via this file. This template lists
# the most important settings you may want to configure for a production cluster.
#
# Please consult the documentation for further information on configuration options:
# https://www.elastic.co/guide/en/elasticsearch/reference/index.html
#
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
#cluster.name: my-application
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
#node.name: node-1
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
# ----------------------------------- Paths ------------------------------------
#
# Path to directory where to store the data (separate multiple locations by comma):
#
#path.data: /path/to/data
#
# Path to log files:
#
#path.logs: /path/to/logs
#
# ----------------------------------- Memory -----------------------------------
#
# Lock the memory on startup:
#
#bootstrap.memory_lock: true
#
# Make sure that the heap size is set to about half the memory available
# on the system and that the owner of the process is allowed to use this
# limit.
#
# Elasticsearch performs poorly when the system is swapping the memory.
#
# ---------------------------------- Network -----------------------------------
#
# By default Elasticsearch is only accessible on localhost. Set a different
# address here to expose this node on the network:
#
#network.host: 192.168.0.1
#
# By default Elasticsearch listens for HTTP traffic on the first free port it
# finds starting at 9200. Set a specific HTTP port here:
#
#http.port: 9200
#
# For more information, consult the network module documentation.
#
# --------------------------------- Discovery ----------------------------------
#
# Pass an initial list of hosts to perform discovery when this node is started:
# The default list of hosts is ["127.0.0.1", "[::1]"]
#
#discovery.seed_hosts: ["host1", "host2"]
#
# Bootstrap the cluster using an initial set of master-eligible nodes:
#
#cluster.initial_master_nodes: ["node-1", "node-2"]
#
# For more information, consult the discovery and cluster formation module documentation.
#
# ---------------------------------- Various -----------------------------------
#
# Allow wildcard deletion of indices:
#
#action.destructive_requires_name: false
cluster.name: "project-test-es-cluster"
network.host: 0.0.0.0
xpack.security.enabled: false
```

点击 `√` 



##### 添加 `jvm.options`

点击添加数据 ，key就是配置文件的文件名 `jvm.options`, value 就是基于官方配置文件修改后的 `jvm.options` 的内容:

```properties
################################################################
##
## JVM configuration
##
################################################################
##
## WARNING: DO NOT EDIT THIS FILE. If you want to override the
## JVM options in this file, or set any additional options, you
## should create one or more files in the jvm.options.d
## directory containing your adjustments.
##
## See https://www.elastic.co/guide/en/elasticsearch/reference/8.8/jvm-options.html
## for more information.
##
################################################################



################################################################
## IMPORTANT: JVM heap size
################################################################
##
## The heap size is automatically configured by Elasticsearch
## based on the available memory in your system and the roles
## each node is configured to fulfill. If specifying heap is
## required, it should be done through a file in jvm.options.d,
## which should be named with .options suffix, and the min and
## max should be set to the same value. For example, to set the
## heap to 4 GB, create a new file in the jvm.options.d
## directory containing these lines:
##
## -Xms4g
## -Xmx4g
##
## See https://www.elastic.co/guide/en/elasticsearch/reference/8.8/heap-size.html
## for more information
##
################################################################


################################################################
## Expert settings
################################################################
##
## All settings below here are considered expert settings. Do
## not adjust them unless you understand what you are doing. Do
## not edit them in this file; instead, create a new file in the
## jvm.options.d directory containing your adjustments.
##
################################################################

-XX:+UseG1GC

## JVM temporary directory
-Djava.io.tmpdir=${ES_TMPDIR}

## heap dumps

# generate a heap dump when an allocation from the Java heap fails; heap dumps
# are created in the working directory of the JVM unless an alternative path is
# specified
-XX:+HeapDumpOnOutOfMemoryError

# exit right after heap dump on out of memory error
-XX:+ExitOnOutOfMemoryError

# specify an alternative path for heap dumps; ensure the directory exists and
# has sufficient space
-XX:HeapDumpPath=data

# specify an alternative path for JVM fatal error logs
-XX:ErrorFile=logs/hs_err_pid%p.log

## GC logging
-Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,level,pid,tags:filecount=32,filesize=64m
```

点击 `√` ，点击创建。这样创建了一个ConfigMap，里面包含2个配置项。





### 部署es

点击 `应用负载-工作负载`，由于es是中间件，属于有状态的应用，所以这里切换到 `有状态副本集`，点击`创建`

##### 基本信息：

```bash
名称：elasticsearch-standalone
别名：project-test-elasticsearch-standalone
描述：测试项目的elasticsearch单节点服务
```



##### 容器组设置：

容器组副本数量： 1

容器：

​	点击添加容器，设置：

​	镜像：参考dockerhub的镜像描述，这里选择 `elasticsearch:8.8.1`，直接输入 elasticsearch:8.8.1 ，输入之后会自动从dockerhub搜索

​	点击 `使用默认端口`

​	资源预留、资源限制：预留就是启动的时候占用的资源（cpu，内存），这里作为测试不预留资源，避免资源浪费。仅做资源限制，这里限制为 2Core 1024Mi



**配置环境变量**：在配置界面下找到 `环境变量`，添加环境变量，根据docker启动命令：

```bash
-e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
```

添加环境变量：

```bash
key= discovery.type   value= single-node
key= ES_JAVA_OPTS     value= -Xms512m -Xmx512m
```



勾选**同步主机时区**，点击`√`，点击下一步。





#### 存储设置

##### 挂载数据

由于没有提前创建pvc，这里要点击 `添加持久卷声明模板`。输入：

```
PVC名称前缀 ： pvc-elaticsearch-standalone
存储类      ：使用默认的nfs-storage
访问模式    ：有状态副本集选择 ReadWriteOnce
卷容量	    ：5G
数据挂载    ：读写
```

**挂载路径**: 根据docker启动命令：

```bash
-v /mydata/es-01/data:/usr/share/elasticsearch/data \
```

容器内部的挂载路径为 `/usr/share/elasticsearch/data` ，所以这里挂载路径为  /usr/share/elasticsearch/data



##### 挂载配置

配置文件在docker启动命令中为：

```bash
-v es-config:/usr/share/elasticsearch/config \
```

点击`挂载配置字典或保密字典`，点击 `选择配置字典`，选择之前配置的 `es-conf`，  挂载方式选择 `只读` ，这里挂载路径如果填写为 `/usr/share/elasticsearch/config`，那么就表示将 `es-conf`中的 elasticsearch.yml 和 jvm.option 两个配置项作为配置文件挂载到  /usr/share/elasticsearch/config 目录下，该目录下有且仅有这两个配置文件，但是es是由很多配置文件的，因此这里需要特殊处理，使用 `映射子路径`的方式：

##### 挂载elasticsearch.yml :

点击`挂载配置字典或保密字典`，点击 `选择配置字典`，选择之前配置的 `es-conf`，  挂载方式选择 `只读` ，挂载路径填写`/usr/share/elasticsearch/config/elasticsearch.yml`,必须要告诉系统这个路径是子路径，否则系统会把这个路径整体作为一个文件夹。点击路径输入框旁边的按钮 `指定子路径`，在子路径输入框中输入： `elasticsearch.yml`，返回储存设置页，在下面勾选 `选择特定键`，在选择框中选择es-conf中的可以，这里选择 `elasticsearch.yml` ，在路径输入框中输入 elasticsearch.yml ，这里路径必须与前面设置的 `映射子路径` 保持一致。点击 `√`



##### 挂载jvm.options :

点击`挂载配置字典或保密字典`，点击 `选择配置字典`，选择之前配置的 `es-conf`，  挂载方式选择 `只读` ，挂载路径填写`/usr/share/elasticsearch/config/jvm.options`,必须要告诉系统这个路径是子路径，否则系统会把这个路径整体作为一个文件夹。点击路径输入框旁边的按钮 `指定子路径`，在子路径输入框中输入： `jvm.options`，返回储存设置页，在下面勾选 `选择特定键`，在选择框中选择es-conf中的可以，这里选择 `jvm.options` ，在路径输入框中输入 `jvm.options` ，这里路径必须与前面设置的 `映射子路径` 保持一致。点击 `√`



挂载完成，点击下一步，进入`高级设置`，高级设置跳过点击 `创建`即可创建容器。



此时在项目的 `应用负载-工作负载-有状态副本集` 页面中就可以看到刚创建的es容器。点击容器名可以进入详情页。在容器详情页中可以看到

资源状态 修改记录 元数据 监控 环境变量 事件

在资源状态中可以看到容器的列表，点击容器名可以进入容器详情，容器详情中可以点击名字旁边的图标看到容器的日志和进入容器的终端。可以很方便的进入容器，进入容器查看配置文件是否正确挂载：

```bash
cat /usr/share/elasticsearch/config/elasticsearch.yml
```

```bash
cat /usr/share/elasticsearch/config/jvm.options
```



在`配置-配置字典`中可以修改配置，点击 es-conf，点击`编辑YAML`进入编辑页面，根据需要编辑下面的配置文件部分：

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: es-conf
  namespace: mall-cloud
  annotations:
    kubesphere.io/alias-name: mall-cloud-es-configmap
    kubesphere.io/creator: dev-zhao
    kubesphere.io/description: 商城项目elasticsearch配置文件
data:
  elasticsearch.yml: >-
  	# ...
    cluster.name: "mall-cloud-es-cluster"
    network.host: 0.0.0.0
    
  jvm.options: >
    ################################################################
    ## JVM configuration
    ################################################################
	# ...
# ...
```

修改之后保存，一段时间之后在pod中就后自动同步修改后的最新配置，但是由于es不能热更新，因此需要重新创建容器才能应用最新的设置。

点击 应用负载-工作负载， 切换到 有状态副本集 ，点击 mall-cloud-es，进入pod详情，点击 `更多操作-重新创建` 即可重新创建pod。



#### 可访问性

到这里es的pod就部署好了，但是此时还不能从外部访问，要从外部访问，需要在service中暴露端口，将自动生成的service删除，重新创建service。注意删除的时候**不要勾选**关联的资源，关联的资源要保留，仅删除服务。



#### 创建可外网访问的服务

在服务列表，点击创建。点击`指定工作负载`，进入基本信息，输入

名称: es-service

别名: project-test-es-service

描述: 测试项目es服务

点击下一步，进入`服务设置`

内部访问模式：

​	虚拟IP地址：在集群外也能访问

​	内部域名：仅能在集群内访问

选择虚拟IP地址，



点击指定工作负载：

切换到 `有状态副本集`，选择 es-standalone



设置端口：

协议： HTTP

名称： HTTP-9200

容器端口: 容器内部的端口，es使用的是 9200

服务端口: 服务暴露的端口，这里也用 9200



点击下一步，进入高级设置：

勾选 `外部访问`，访问模式选择 `NodePort`，点击 `创建` ，创建好服务后，服务会暴露一个随机的（30000~32767）端口，如果有防火墙，需要在防火墙开启该端口。在外部通过http客户端连接任意k8s节点地址（这里是 192.168.0.112/113/114）+**随机端口**（注意不是 9200）

```bash
curl http://192.168.0.112:3xxxx
```



#### 创建仅集群内访问的服务

在服务列表，点击创建。点击`指定工作负载`，进入基本信息，输入

名称: es-service-in-cluster

别名: project-test-es-service-in-cluster

描述: 电商项目es服务，仅集群内访问

点击下一步，进入`服务设置`

内部访问模式：

​	虚拟IP地址：在集群外也能访问

​	内部域名：仅能在集群内访问

选择内部域名。



点击指定工作负载：

切换到 `有状态副本集`，选择 es-standalone



设置端口：

协议： HTTP

名称： HTTP-9200

容器端口: 9200

服务端口: 9200



协议： TCP

名称： TCP-9300

容器端口: 9300

服务端口: 9300



点击下一步，进入高级设置：

**不要勾选** `外部访问`，直接点击创建。创建服务后，在服务详情页查看服务的dns格式为 `<service-name>-<namespace>`， 如：DNS: es-service-in-cluster.mall-cloud，在集群内的节点可以通过 es-service-in-cluster.mall-cloud+端口来进行访问。

```bash
curl http://es-service-in-cluster.project-test:9200
```



注意：在部署有状态副本集时，应该在创建部署时点击 `添加持久卷声明模板`方式使用pvc，原因时比如要部署多个 mysql / redis / es 实例，每一个实例都应该使用独立的持久化卷。使用 添加持久卷申明模板 有一个优势，就是在实例伸缩时，比如由 1个实例扩容到3个实例时，会自动创建3个持久化卷，每一个节点都使用独立的持久化卷。如果手动设置pvc， 在进行扩容时，比如扩容到2个实例，这2个实例使用的数据是同一份。这样是会有问题的。

**有状态应用创建时，一定要使用 持久卷声明模板 ，而不是手动指定持久化卷申明**





