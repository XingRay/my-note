## KubeSphere设置服务探针

一次k8s项目重启后有很多的微服务初始化报错，经过排查原因是nacos没有正常启动，nacos没有正常启动时因为nacos使用了mysql作为配置的持久化数据源，而且nacos启动比mysql快，nacos尝试访问mysql，但是此时mysql还没有初始化完成，导致nacos启动失败，而且nacos访问mysql失败后，不会在mysql启动之后再重试，所以会在nacos的日志中看到报错：

```bash
Caused by: java.lang.IllegalStateException: No DataSource set
```

由于nacos没有就绪，就导致依赖nacos的微服务也无法正常启动。

要解决这个问题，就需要在mysql启动之后，再让k8s启动nacos，想要让服务按顺序启动很麻烦，但是可以在nacos启动之后检测nacos是否真正的启动成功，如果nacos没有真正的启动成功就让k8s重启nacos。这样在mysql启动之后，nacos只要重启了就可以正常启动。这种机制就是k8s的 `探针`



如果nacos正常启动，那么在nacos所在的pod的任何容器中，包括nacos自身的容器，访问 http://127.0.0.1:8848/nacos 就一定是可以访问的。在容器中执行

```bash
curl  http://127.0.0.1:8848/nacos
```

虽然没有返回，但是不会报错，说明是可以正常访问的，利用这一点可以做nacos服务的`健康检查`



在 `应用负载-工作负载`中切换到 `有状态副本集`，点击 `nacos-cluster-v1`，进入部署详情页，点击 `更多操作-编辑设置`， 在`编辑设置`页中切换到`容器`，点击右边容器列表中的nacos容器右边的编辑图标， 进入 `编辑容器` 页，找到下面的健康检查，勾选`健康检查`，这里有3中探针可以添加，这里添加存活检查，点击`存活检查-添加探针`，在 `存活检查`编辑页面，切换到`HTTP请求`，填写信息：

```bash
路径：
	协议：HTTP
	路径：/nacos
	端口：8848
初始延迟（s）：20  启动20s之后再做测试
超时时间（s）：3   检测请求在3s内必选返回，否则认为检查失败
检查间隔（s）：30	开始检查后，每30s做一次检查
成功阈值： 	 1   只要成功一次就认为当前检查成功，服务处于健康状态
失败阈值：	 3   连续3次检查失败则认为服务处于非健康状态，要重启服务
```

点击`√`即添加完成。更新配置后服务会重启pod，点击pod列表可以看到有显示 `探针`。











