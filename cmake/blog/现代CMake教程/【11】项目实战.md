# ã€11ã€‘é¡¹ç›®å®æˆ˜

## [1. å¸¸è§„éè·¨å¹³å°é¡¹ç›®](https://www.cccolt.top/tutorial/cmake/11.html#_1-å¸¸è§„éè·¨å¹³å°é¡¹ç›®)

### [1.1 é¢„æœŸç›®æ ‡](https://www.cccolt.top/tutorial/cmake/11.html#_1-1-é¢„æœŸç›®æ ‡)

ç°è®¡åˆ’å¼€å‘ä¸€ä¸ªä¸“ä¸º Linux å¹³å°è®¾è®¡çš„è§†è§‰å¤„ç†åº“ `visionlib` åŠç¤ºä¾‹ç¨‹åº `vl_demo`ï¼Œåº“åœ¨ä»æºç ç¼–è¯‘å®‰è£…çš„è¿‡ç¨‹ä¸­éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. éœ€è¦æ”¯æŒ C++17 æ ‡å‡†ï¼›

2. å¼ºåˆ¶ä¾èµ– OpenCV 4 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¹¶ç”¨åˆ°å…¶ä¸­çš„ `core`ã€`imgproc`ã€`highgui` æ¨¡å—ï¼Œåˆ†åˆ«å¯¹åº” `opencv_core`ã€`opencv_imgproc`ã€`opencv_highgui` è¿™ 3 ä¸ª CMake ç›®æ ‡ï¼›

3. é»˜è®¤ä»¥é™æ€åº“çš„å½¢å¼æ„å»º `visionlib`ï¼Œä½†å…è®¸ç”¨æˆ·é€šè¿‡ CMake é€‰é¡¹è®¾ç½®æ„å»ºä¸ºåŠ¨æ€åº“ï¼›

4. åº“åŒ…å«äº† `vl_a`ã€`vl_b`ã€`vl_c` å’Œ `vl_d` å…± 4 ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«å¯¹åº” `a`ã€`b`ã€`c` å’Œ `d` 4 ä¸ªæ–‡ä»¶å¤¹ï¼Œå‡é»˜è®¤å‚ä¸æ„å»ºï¼Œä½†æ˜¯å…è®¸ç”¨æˆ·é€šè¿‡ CMake é€‰é¡¹è®¾ç½®ä»»ä¸€æ¨¡å—æ˜¯å¦å‚ä¸æ„å»ºï¼›

5. é¡¹ç›®åŒ…å«äº†ä¸€ä¸ªç¤ºä¾‹ç¨‹åº `vl_demo`ï¼Œé»˜è®¤å‚ä¸æ„å»ºï¼Œå…è®¸ç”¨æˆ·é€šè¿‡ CMake é€‰é¡¹è®¾ç½®å…¶æ˜¯å¦å‚ä¸æ„å»ºï¼›

6. è¿™å‡ ä¸ªæ¨¡å—å’Œç¤ºä¾‹ç¨‹åºä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä½¿ç”¨ â†’ è¡¨ç¤ºä¾èµ–å…³ç³»ï¼Œå¦‚ ![11-normal-deps-example](./assets/11-normal-deps-example.png) è¡¨ç¤º `vl_c` ä¾èµ– `vl_a`

   ![11-normal-deps](./assets/11-normal-deps.png)

   **å›¾ 1-1ï¼šä¾èµ–å…³ç³»å›¾**

7. é¡¹ç›®çš„å®‰è£…ç›®å½•ä¸º `/usr/local`ï¼Œå…¶ä¸­

   - ç¤ºä¾‹ç¨‹åºå®‰è£…åˆ° `/usr/local/bin`
   - å¤´æ–‡ä»¶å®‰è£…åˆ° `/usr/local/include`
   - åº“æ–‡ä»¶å®‰è£…åˆ° `/usr/local/lib`
   - CMake ç›¸å…³é…ç½®æ–‡ä»¶å®‰è£…åˆ° `/usr/local/lib/cmake/VisionLib`

### [1.2 è¦æ±‚ä¸æ–‡ä»¶ç»“æ„](https://www.cccolt.top/tutorial/cmake/11.html#_1-2-è¦æ±‚ä¸æ–‡ä»¶ç»“æ„)

è¯¥é¡¹ç›®ä¸­æ‰€æœ‰çš„ CMake ç›®æ ‡å¿…é¡»å‡ä»¥ `vl_` å¼€å¤´ï¼Œä¾‹å¦‚æ–‡ä»¶å¤¹ `a` å¯¹åº”çš„ç›®æ ‡æ˜¯ `vl_a`ï¼Œè¯¥é¡¹ç›®çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹



```
.
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ a
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ visionlib
â”‚   â”‚   â”‚       â””â”€â”€ a.hpp
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â”œâ”€â”€ a1.cpp
â”‚   â”‚       â””â”€â”€ a2.cpp
â”‚   â”œâ”€â”€ b
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ visionlib
â”‚   â”‚   â”‚       â””â”€â”€ b.hpp
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â”œâ”€â”€ b1.cpp
â”‚   â”‚       â”œâ”€â”€ b2.cpp
â”‚   â”‚       â”œâ”€â”€ b3.cpp
â”‚   â”‚       â””â”€â”€ b4.cpp
â”‚   â”œâ”€â”€ c
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ visionlib
â”‚   â”‚   â”‚       â””â”€â”€ c.hpp
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ c.cpp
â”‚   â””â”€â”€ d
â”‚       â”œâ”€â”€ include
â”‚       â”‚   â””â”€â”€ visionlib
â”‚       â”‚       â””â”€â”€ d.hpp
â”‚       â””â”€â”€ src
â”‚           â”œâ”€â”€ d1.cpp
â”‚           â””â”€â”€ d2.cpp
â””â”€â”€ samples
    â””â”€â”€ demo.cpp

19 directories, 14 files
```

### [1.3 åˆ†æ](https://www.cccolt.top/tutorial/cmake/11.html#_1-3-åˆ†æ)

- å‰ 3 ä¸ªé¢„æœŸç›®æ ‡æ˜¯å…³äºé¡¹ç›®çš„è¦æ±‚ï¼Œå¯ç›´æ¥åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `CMakeLists.txt` ä¸­å®ç°
- ç¬¬ 4 åˆ°ç¬¬ 6 ä¸ªé¢„æœŸç›®æ ‡æ˜¯å…³äºé¡¹ç›®çš„ä¾èµ–å…³ç³»ï¼Œå¯åœ¨æ¯ä¸ªæ¨¡å—çš„ `CMakeLists.txt` ä¸­å®ç°
- æ¯ä¸ªæ¨¡å—å‡æ¶‰åŠåˆ°å¤´æ–‡ä»¶æœç´¢è·¯å¾„æ·»åŠ ã€æºæ–‡ä»¶ç¼–è¯‘ã€åº“æ–‡ä»¶é“¾æ¥ã€ä¾èµ–åº“æ·»åŠ ã€å®‰è£…ç›®æ ‡ç­‰æ“ä½œï¼Œå¯ä»¥å°†è¿™äº›å†…å®¹å°è£…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œç„¶ååœ¨æ¯ä¸ªæ¨¡å—çš„ `CMakeLists.txt` ä¸­è°ƒç”¨

### [1.4 å®ç°](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-å®ç°)

åœ¨é¡¹ç›®ä¸­æ·»åŠ 

- `CMakeLists.txt` â€”â€” é¡¹ç›®æ ¹ç›®å½•çš„ CMake é…ç½®æ–‡ä»¶
- `cmake/VisionLibInstall.cmake` â€”â€” é¡¹ç›®çš„å®‰è£…è·¯å¾„é…ç½®æ–‡ä»¶
- `cmake/VisionLibModule.cmake` â€”â€” é¡¹ç›®çš„ CMake å‡½æ•°åº“ï¼Œä¸»è¦æ¶‰åŠåˆ°ç›®æ ‡çš„ä¾¿æ·åˆ›å»º
- `cmake/templates/VisionLibConfig.cmake.in` â€”â€” é¡¹ç›®åœ¨ `find_package` æ—¶éœ€è¦çš„é…ç½®æ–‡ä»¶æ¨¡æ¿
- `modules/CMakeLists.txt` â€”â€” é¡¹ç›®çš„æ¨¡å—åˆ—è¡¨
- `modules/a/CMakeLists.txt` â€”â€” æ¨¡å— `a` çš„ CMake é…ç½®æ–‡ä»¶
- `modules/b/CMakeLists.txt` â€”â€” æ¨¡å— `b` çš„ CMake é…ç½®æ–‡ä»¶
- `modules/c/CMakeLists.txt` â€”â€” æ¨¡å— `c` çš„ CMake é…ç½®æ–‡ä»¶
- `modules/d/CMakeLists.txt` â€”â€” æ¨¡å— `d` çš„ CMake é…ç½®æ–‡ä»¶
- `samples/CMakeLists.txt` â€”â€” ç¤ºä¾‹ç¨‹åºçš„ CMake é…ç½®æ–‡ä»¶

å…± 10 ä¸ªæ–‡ä»¶ã€‚

#### [1.4.1 é¡¹ç›®é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-1-é¡¹ç›®é…ç½®)

CMakeLists.txtVisionLibInstall.cmakeVisionLibModule.cmake



```
cmake_minimum_required(VERSION 3.10)

project(VisionLib)

# ----------------------------------------------------------------------------
#   é…ç½®é¡¹ç›®
# ----------------------------------------------------------------------------
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

find_package(OpenCV 4 REQUIRED)
option(BUILD_SHARED_LIBS "Build shared libraries?" OFF)

include(cmake/VisionLibInstall.cmake)
include(cmake/VisionLibModule.cmake)

# ----------------------------------------------------------------------------
#   å°†å­ç›®å½•æ·»åŠ åˆ°æ„å»ºç³»ç»Ÿä¸­
# ----------------------------------------------------------------------------
add_subdirectory(modules)
add_subdirectory(samples)

# ----------------------------------------------------------------------------
#   å¯¼å‡ºã€å®‰è£…é…ç½®
# ----------------------------------------------------------------------------
install(
  EXPORT VisionLibTargets
  FILE VisionLibTargets.cmake
  DESTINATION ${VL_CFG_INSTALL_PATH}
  # VL_CFG_INSTALL_PATH å®šä¹‰äº VisionLibInstall.cmake ä¸­
)

configure_file(
  cmake/templates/VisionLibConfig.cmake.in
  "${CMAKE_CURRENT_BINARY_DIR}/VisionLibConfig.cmake"
  @ONLY
)

install(
  FILES "${CMAKE_CURRENT_BINARY_DIR}/VisionLibConfig.cmake"
  DESTINATION ${VL_CFG_INSTALL_PATH}
)
```

#### [1.4.2 æ¨¡å—é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-2-æ¨¡å—é…ç½®)

```
modules``modules/a``modules/b``modules/c``modules/d
```



```
set(cur_path "${CMAKE_CURRENT_SOURCE_DIR}")
file(GLOB modules RELATIVE "${cur_path}" "${cur_path}/*")

foreach(m ${modules})
  if(IS_DIRECTORY ${cur_path}/${m})
    add_subdirectory(${cur_path}/${m})
  endif()
endforeach()

# ç®€å•èµ·è§ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™
# add_subdirectory(a)
# add_subdirectory(b)
# add_subdirectory(c)
# add_subdirectory(d)
```

#### [1.4.3 ç¤ºä¾‹ç¨‹åºé…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-3-ç¤ºä¾‹ç¨‹åºé…ç½®)

samples/CMakeLists.txt



```
vl_add_exe(demo
  SOURCES demo.cpp
  DEPENDS d
  EXT_DEPENDS opencv_highgui
)
```

#### [1.4.4 VisionLibConfig.cmake.in é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-4-visionlibconfig-cmake-in-é…ç½®)

è‹¥å¯¹è¯¥æ–‡ä»¶æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒ[æ­¤å¤„](https://www.cccolt.top/tutorial/cmake/10.html#_4-xxxconfig-cmake-æ–‡ä»¶çš„ä¸€èˆ¬å†™æ³•)ã€‚

VisionLibConfig.cmake.in



```
# ----------------------------------------------------------------------------
#  VisionLib CMake é…ç½®æ–‡ä»¶
#
#                  ** è¯¥æ–‡ä»¶ç”± CMake ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ **
#
#  åŸºæœ¬ç”¨æ³•ï¼š
#    find_package(VisionLib REQUIRED)
#    target_link_libraries(your_target PRIVATE vl_a vl_b ...)
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
#   è·å– VisionLib å®‰è£…è·¯å¾„
# ----------------------------------------------------------------------------
get_filename_component(VL_CONFIG_PATH
  "${CMAKE_CURRENT_LIST_FILE}" PATH
)
set(VL_INSTALL_PATH "@VL_INSTALL_PATH@")

# ----------------------------------------------------------------------------
#   è®¾ç½®å¤´æ–‡ä»¶æœç´¢è·¯å¾„å˜é‡
# ----------------------------------------------------------------------------
set(VisionLib_INCLUDE_DIRS "${VL_INSTALL_PATH}/@VL_INC_INSTALL_PATH@")

# ----------------------------------------------------------------------------
#   è®¾ç½®åº“æ–‡ä»¶è·¯å¾„å˜é‡
# ----------------------------------------------------------------------------
set(VisionLib_LIBS @VL_LIB_COMPONENTS@)

if(NOT TARGET vl_a)
  include("${VL_CONFIG_PATH}/VisionLibTargets.cmake")
endif()

# ----------------------------------------------------------------------------
#   æœå¯»çš„ç»“æœã€çŠ¶æ€
# ----------------------------------------------------------------------------
include(FindPackageHandleStandardArgs)

find_package_handle_standard_args(VisionLib
  REQUIRED_VARS VL_INSTALL_PATH
)
```

### [1.5 æ€è€ƒ ğŸ¤”](https://www.cccolt.top/tutorial/cmake/11.html#_1-5-æ€è€ƒ)

ç”¨æˆ·åœ¨ä½¿ç”¨ VisionLib ä¸­çš„ `vl_d` ç›®æ ‡çš„æ—¶å€™ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­ä¼šå†™ä¸Š



```
add_executable(demo main.cpp)

find_package(VisionLib REQUIRED)

target_link_libraries(demo PRIVATE vl_d)
```

ä½†æ˜¯è¿™æ—¶å€™ç¼–è¯‘ä¼šå‡ºç°å½¢å¦‚ä»¥ä¸‹å†…å®¹çš„æŠ¥é”™



```
[ 50%] Building CXX object CMakeFiles/demo.dir/main.cpp.o
In file included from /usr/local/include/VisionLib/visionlib/d.hpp:3,
                 from /path/to/vl_deploy_demo/main.cpp:1:
/usr/local/include/VisionLib/visionlib/c.hpp:5:10: fatal error: opencv2/core.hpp: No such file or directory
    5 | #include <opencv2/core.hpp>
      |          ^~~~~~~~~~~~~~~~~~
compilation terminated.
make[2]: *** [CMakeFiles/demo.dir/build.make:76ï¼šCMakeFiles/demo.dir/main.cpp.o] error 1
make[1]: *** [CMakeFiles/Makefile2:83ï¼šCMakeFiles/demo.dir/all] error 2
make: *** [Makefile:91ï¼šall] error 2
```

è¯·åˆ†æå‡ºç°è¯¥é—®é¢˜çš„åŸå› ä»¥åŠè§£å†³æ–¹æ³•ã€‚

**ç­”æ¡ˆ** [ã€ç‚¹æ­¤æŸ¥çœ‹ã€‘](https://www.cccolt.top/tutorial/cmake/11/answer.html#_1-å¸¸è§„éè·¨å¹³å°é¡¹ç›®)

## [2. å¤–éƒ¨ä¾èµ–ç®¡ç†](https://www.cccolt.top/tutorial/cmake/11.html#_2-å¤–éƒ¨ä¾èµ–ç®¡ç†)

C/C++ ä¸€ä¸ªé¥±å—è¯Ÿç—…çš„è¯é¢˜å°±æ˜¯åŒ…ç®¡ç†ï¼Œä¸€äº›ç°ä»£çš„è¯­è¨€éƒ½å…·æœ‰æ¯”è¾ƒå®Œå–„çš„åŒ…ç®¡ç†å·¥å…·ï¼Œä¾‹å¦‚ Python çš„ `pip`ã€Node.js çš„ `npm` å’Œ `yarn`ã€Rust çš„ `cargo` ç­‰ï¼Œè€Œ C/C++ æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ã€å®˜æ–¹çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå¯¼è‡´äº† C/C++ é¡¹ç›®çš„ä¾èµ–ç®¡ç†éå¸¸å›°éš¾ã€‚CMake æä¾›äº† `FetchContent` å’Œ `ExternalProject` æ¨¡å—ï¼Œå¯ä»¥ç”¨äºç®¡ç†é¡¹ç›®çš„å¤–éƒ¨ä¾èµ–ï¼Œç›¸æ¯”äºæ‰‹åŠ¨ä¸‹è½½ã€ç¼–è¯‘ã€å®‰è£…ï¼Œ`FetchContent` å’Œ `ExternalProject` å·²ç»å°½å¯èƒ½çš„ç®€åŒ–äº†è¿™ä¸ªè¿‡ç¨‹ã€‚

`ExternalProject` ç”¨äºåœ¨æ„å»ºè¿‡ç¨‹ä¸­ä¸‹è½½ã€é…ç½®ã€æ„å»ºå’Œå®‰è£…å¤–éƒ¨é¡¹ç›®ã€‚å®ƒé€šå¸¸ç”¨äºå¤„ç†å¤§å‹çš„ã€ç‹¬ç«‹çš„å¤–éƒ¨é¡¹ç›®ã€‚è€Œ `FetchContent` ç”¨äºåœ¨é…ç½®é˜¶æ®µä¸‹è½½å’Œæ·»åŠ å¤–éƒ¨é¡¹ç›®çš„æºä»£ç ã€‚å®ƒé€‚ç”¨äºéœ€è¦å°†å¤–éƒ¨é¡¹ç›®çš„æºä»£ç ç›´æ¥é›†æˆåˆ°ä¸»é¡¹ç›®ä¸­çš„æƒ…å†µã€‚åæ–‡å°†ä¸»è¦ä»‹ç» `FetchContent` çš„ä½¿ç”¨ï¼Œ`ExternalProject` çš„ä½¿ç”¨å¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://cmake.org/cmake/help/latest/module/ExternalProject.html)ã€‚

### [2.1 `FetchContent`](https://www.cccolt.top/tutorial/cmake/11.html#_2-1-fetchcontent)

`FetchContent` ä¾èµ–ç®¡ç†å®šä¹‰äº `FetchContent` CMake æ¨¡å—ä¸­ï¼Œå¯ä½¿ç”¨



```
include(FetchContent)
```

æ¥å¼•å…¥ã€‚`FetchContent` æ¨¡å—æä¾›äº† `FetchContent_Declare`ã€`FetchContent_MakeAvailable` ç­‰å‡½æ•°ï¼Œç”¨äºä¸‹è½½ã€è§£å‹ã€é…ç½®ã€ç¼–è¯‘ã€å®‰è£…å¤–éƒ¨é¡¹ç›®ã€‚

#### [2.1.1 `FetchContent_Declare`](https://www.cccolt.top/tutorial/cmake/11.html#_2-1-1-fetchcontent-declare)

â€”â€” å£°æ˜å¤–éƒ¨ä¾èµ–é¡¹



```
FetchContent_Declare(
  <name>
  <contentOptions>...
  [EXCLUDE_FROM_ALL]          # add in CMake 3.28
  [SYSTEM]                    # add in CMake 3.25
  [OVERRIDE_FIND_PACKAGE |
   FIND_PACKAGE_ARGS args...] # add in CMake 3.24
)
```

ä¸Šè¿°å£°æ˜çš„å¯é€‰é¡¹å‡ä¸æ˜¯å¾ˆé‡è¦ï¼Œé‡è¦çš„æ˜¯ `<contentOptions>`ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨ `FetchContent_Declare` å£°æ˜ `googletest` é¡¹ç›®çš„ç¤ºä¾‹ï¼Œæä¾›äº†ä¸¤ç§æ–¹å¼å£°æ˜å¤–éƒ¨ä¾èµ–é¡¹ï¼Œä¸€ç§æ˜¯ä½¿ç”¨ Git å­˜å‚¨åº“ä½œä¸ºå¤–éƒ¨ä¾èµ–é¡¹ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨ URL åœ°å€ä½œä¸ºå¤–éƒ¨ä¾èµ–é¡¹ã€‚

ä½¿ç”¨ Git å­˜å‚¨åº“ä½¿ç”¨ URL åœ°å€



```
FetchContent_Declare(
  googletest
  GIT_REPOSITORY https://github.com/google/googletest.git
  GIT_TAG        703bd9caab50b139428cea1aaff9974ebee5742e # release-1.10.0
)

# GIT_REPOSITORY: è¡¨ç¤ºå¤–éƒ¨ä¾èµ–é¡¹çš„ Git ä»“åº“åœ°å€ï¼›
# GIT_TAG:        è¡¨ç¤ºå¤–éƒ¨ä¾èµ–é¡¹çš„ Git ä»“åº“çš„æ ‡ç­¾ï¼Œå¯ä»¥æ˜¯åˆ†æ”¯åã€æ ‡ç­¾åã€æäº¤å“ˆå¸Œç­‰ï¼Œ
#                 ä½†å»ºè®®æ˜¯ç¨³å®šçš„æ ‡ç­¾åé˜²æ­¢ä¸ç¨³å®šçš„ä»£ç è¿›å…¥é¡¹ç›®ã€‚
```

#### [2.1.2 `FetchContent_MakeAvailable`](https://www.cccolt.top/tutorial/cmake/11.html#_2-1-2-fetchcontent-makeavailable)

â€”â€” ä½¿å¤–éƒ¨ä¾èµ–é¡¹ç”Ÿæ•ˆï¼Œå¹¶åŠ å…¥æ„å»ºç³»ç»Ÿ



```
FetchContent_MakeAvailable(<name1> [<name2>...])
```

è¯¥å‘½ä»¤ä¿è¯åœ¨è°ƒç”¨ç»“æŸåï¼Œæ¯ä¸ªå‘½åçš„ä¾èµ–é¡¹éƒ½å¯ä¾›é¡¹ç›®ä½¿ç”¨ã€‚ä¾‹å¦‚ä¸Šæ–‡çš„ `googletest` é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ï¼š



```
FetchContent_MakeAvailable(googletest)
```

å¦‚æœæœ‰å¤šä¸ªå¤–éƒ¨ä¾èµ–é¡¹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ï¼š



```
FetchContent_MakeAvailable(ext1 ext2 ext3)
```

è¯¥å‘½ä»¤å°†ä¾æ¬¡é…ç½® `ext1`ã€`ext2` å’Œ `ext3` é¡¹ç›®

#### [2.1.3 `FetchContent` ç¤ºä¾‹](https://www.cccolt.top/tutorial/cmake/11.html#_2-1-3-fetchcontent-ç¤ºä¾‹)

æ¥è‡ª[ã€å¤æ‚ä¾èµ–ã€‘](https://cmake.org/cmake/help/latest/module/FetchContent.html#complex-dependency-hierarchies)



```
include(FetchContent)
FetchContent_Declare(
  projB
  GIT_REPOSITORY git@mycompany.com:git/projB.git
  GIT_TAG        4a89dc7e24ff212a7b5167bef7ab079d
)
FetchContent_Declare(
  projC
  GIT_REPOSITORY git@mycompany.com:git/projC.git
  GIT_TAG        4ad4016bd1d8d5412d135cf8ceea1bb9
)
FetchContent_Declare(
  projD
  GIT_REPOSITORY git@mycompany.com:git/projD.git
  GIT_TAG        origin/integrationBranch
)

# Order is important, see notes in the discussion further below
FetchContent_MakeAvailable(projD projB projC)
```

### [2.2 é¢„æœŸç›®æ ‡](https://www.cccolt.top/tutorial/cmake/11.html#_2-2-é¢„æœŸç›®æ ‡)

ç°è®¡åˆ’å¼€å‘ä¸€ä¸ª Windows å¹³å°ä¸‹çš„ OPC UA é€šä¿¡åº“ `opcua`ï¼Œè¯¥åº“ä¾èµ–äº `open62541`[[1\]](https://www.cccolt.top/tutorial/cmake/11.html#footnote1)ï¼Œ`open62541` æ˜¯ä¸€ä¸ªå¼€æºçš„ OPC UA åè®®æ ˆï¼Œæä¾›äº† OPC UA æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ C è¯­è¨€å®ç°ã€‚`opcua` åº“çš„å¼€å‘éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. éœ€è¦æ”¯æŒ C++17 æ ‡å‡†ï¼›

2. å¼ºåˆ¶ä¾èµ– `open62541`ï¼Œæ²¡æœ‰è¯¥åº“éœ€è¦è‡ªåŠ¨ä¸‹è½½ã€å¹¶æ·»åŠ è‡³é¡¹ç›®ä¸­ï¼Œå¦‚æœæ˜¯è‡ªåŠ¨ä¸‹è½½çš„ `open62541`ï¼Œé‚£ä¹ˆ `opcua` åº“åœ¨å®‰è£…æ—¶éœ€è¦å°† `open62541` ä¸€å¹¶å®‰è£…ï¼›

3. ```
   open62541
   ```

    

   çš„é…ç½®è¦æ±‚å¦‚ä¸‹

   - æ— éœ€å¯ç”¨ `UA_ENABLE_AMALGAMATION` é€‰é¡¹ï¼›
   - å…¶ä»–é€‰é¡¹é»˜è®¤å³å¯ï¼›

4. é»˜è®¤ä»¥é™æ€åº“çš„å½¢å¼æ„å»º `opcua`ï¼Œä½†å…è®¸ç”¨æˆ·é€šè¿‡ CMake é€‰é¡¹è®¾ç½®æ„å»ºä¸ºåŠ¨æ€åº“ï¼›

5. ```
   opcua
   ```

    

   é¡¹ç›®çš„å®‰è£…ç›®å½•ä¸º

    

   ```
   D:\opcua
   ```

   ï¼Œå…¶ä¸­

   - å¤´æ–‡ä»¶å®‰è£…åˆ° `D:\opcua\include`ï¼›
   - é™æ€åº“ã€å¯¼å…¥åº“æ–‡ä»¶å®‰è£…åˆ° `D:\opcua\x64\vc16\lib`ï¼›
   - åŠ¨æ€åº“æ–‡ä»¶å®‰è£…åˆ° `D:\opcua\x64\vc16\bin`ï¼ˆå¦‚æœæ„å»ºä¸ºåŠ¨æ€åº“ï¼‰ï¼›
   - CMake ç›¸å…³é…ç½®æ–‡ä»¶å®‰è£…åˆ° `D:\opcua\x64\vc16\bin`ï¼›
   - `open62541` çš„å®‰è£…è¦æ±‚ç”± `open62541Config.cmake` æŒ‡å®šäº†ï¼Œå…·ä½“å®‰è£…è·¯å¾„ä¸åšè¯¦ç»†è¯´æ˜ï¼Œåªéœ€ä¿è¯ `open62541` çš„å®‰è£…è·¯å¾„åœ¨ `D:\opcua` ä¸‹å³å¯ã€‚

### [2.3 æ–‡ä»¶ç»“æ„](https://www.cccolt.top/tutorial/cmake/11.html#_2-3-æ–‡ä»¶ç»“æ„)

è¯¥é¡¹ç›®çš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼Œå‚è€ƒè‡ª [rmvl_opcua æ¨¡å—](https://github.com/cv-rmvl/rmvl/tree/2.x/modules/opcua)ã€‚



```
.
â”œâ”€â”€ include
â”‚   â”œâ”€â”€ opcua
â”‚   â”‚   â”œâ”€â”€ client.hpp
â”‚   â”‚   â”œâ”€â”€ event.hpp
â”‚   â”‚   â”œâ”€â”€ method.hpp
â”‚   â”‚   â”œâ”€â”€ object.hpp
â”‚   â”‚   â”œâ”€â”€ publisher.hpp
â”‚   â”‚   â”œâ”€â”€ server.hpp
â”‚   â”‚   â”œâ”€â”€ subscriber.hpp
â”‚   â”‚   â”œâ”€â”€ utilities.hpp
â”‚   â”‚   â”œâ”€â”€ variable.hpp
â”‚   â”‚   â””â”€â”€ view.hpp
â”‚   â””â”€â”€ opcua.hpp
â””â”€â”€ src
    â”œâ”€â”€ client.cpp
    â”œâ”€â”€ cvt.hpp
    â”œâ”€â”€ helper.cpp
    â”œâ”€â”€ publisher.cpp
    â”œâ”€â”€ server.cpp
    â””â”€â”€ subscriber.cpp

6 directories, 19 files
```

### [2.4 å®ç°](https://www.cccolt.top/tutorial/cmake/11.html#_2-4-å®ç°)

åœ¨é¡¹ç›®ä¸­æ·»åŠ 

- `3rdparty/open62541/CMakeLists.txt` â€”â€” `open62541` çš„é…ç½®æ–‡ä»¶
- `CMakeLists.txt` â€”â€” é¡¹ç›®æ ¹ç›®å½•çš„ CMake é…ç½®æ–‡ä»¶
- `cmake/opcuaInstall.cmake` â€”â€” é¡¹ç›®çš„å®‰è£…è·¯å¾„é…ç½®æ–‡ä»¶
- `cmake/opcuaConfig.cmake` â€”â€” æä¾›ç»™ç”¨æˆ·åœ¨ `find_package` æ—¶æ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶ï¼ˆå› ä¸ºæ•´ä¸ªé¡¹ç›®åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼Œè¿™é‡Œå°±ä¸ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶äº†ï¼‰

å…± 4 ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸‹æ–‡ä»¶ç»“æ„æ‰€ç¤º



```
.
â”œâ”€â”€ 3rdparty
â”‚   â””â”€â”€ open62541
â”‚       â””â”€â”€ CMakeLists.txt (New)
â”œâ”€â”€ CMakeLists.txt         (New)
â”œâ”€â”€ cmake
â”‚   â”œâ”€â”€ opcuaConfig.cmake  (New)
â”‚   â””â”€â”€ opcuaInstall.cmake (New)
â”œâ”€â”€ include
â”‚   â””â”€â”€ ...
â””â”€â”€ src
    â””â”€â”€ ...
```

#### [2.4.1 é¡¹ç›®é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_2-4-1-é¡¹ç›®é…ç½®)

CMakeLists.txtopcuaInstall.cmake



```
# --------------------------------------------------------
#  é¡¹ç›®é…ç½®
# --------------------------------------------------------
cmake_minimum_required(VERSION 3.16)
project(opcua)

set(CMAKE_CXX_STANDARD 17)
option(BUILD_SHARED_LIBS "Build shared libraries?" OFF)

include(cmake/opcuaInstall.cmake)

# --------------------------------------------------------
#  å¤–éƒ¨ä¾èµ–ç®¡ç†
# --------------------------------------------------------
find_package(open62541 QUIET)
if(NOT open62541_FOUND)
  add_subdirectory(3rdparty/open62541)
endif()

# --------------------------------------------------------
#  ç›®æ ‡æ„å»º
# --------------------------------------------------------
aux_source_directory(src target_src)
add_library(opcua ${target_src})

target_include_directories(opcua PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<INSTALL_INTERFACE:include>
)

target_link_libraries(opcua
  PUBLIC open62541::open62541
)

install(
  TARGETS opcua
  EXPORT opcuaTarget
  LIBRARY DESTINATION ${OPCUA_BIN_INSTALL_PATH}
  ARCHIVE DESTINATION ${OPCUA_LIB_INSTALL_PATH}
  RUNTIME DESTINATION ${OPCUA_BIN_INSTALL_PATH}
  INCLUDES DESTINATION ${OPCUA_INC_INSTALL_PATH}
)

# --------------------------------------------------------
#  å¯¼å‡ºã€å®‰è£…
# --------------------------------------------------------
install(
  EXPORT opcuaTarget
  FILE opcuaTarget.cmake
  DESTINATION ${OPCUA_CFG_INSTALL_PATH}
)

install(
  FILES cmake/opcuaConfig.cmake
  DESTINATION ${OPCUA_CFG_INSTALL_PATH}
)
```

#### [2.4.2 å¤–éƒ¨ä¾èµ–é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_2-4-2-å¤–éƒ¨ä¾èµ–é…ç½®)

3rdparty/open62541/CMakeLists.txt



```
option(UA_ENABLE_AMALGAMATION "Enable amalgamation" OFF)

FetchContent_Declare(
  open62541
  GIT_REPOSITORY https://github.com/open62541/open62541.git
  GIT_TAG        v1.4.8
)

FetchContent_MakeAvailable(open62541)
```

#### [2.4.4 opcuaConfig.cmake é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_2-4-4-opcuaconfig-cmake-é…ç½®)

ç”±äº `opcua` é¡¹ç›®åªæœ‰ä¸€ä¸ªç›®æ ‡ï¼Œå› æ­¤ `opcuaConfig.cmake` æ–‡ä»¶éå¸¸ç®€å•ï¼Œæ–¹ä¾¿èµ·è§ä¹Ÿä¸éœ€è¦å‘ç”¨æˆ·æä¾›è¯¸å¦‚ `opcua_INCLUDE_DIRS` å’Œ `opcua_LIBS` è¿™æ ·çš„é›†åˆå˜é‡ï¼Œå› æ­¤ `opcuaConfig.cmake` åªéœ€è¦å®Œæˆä»¥ä¸‹åŠŸèƒ½å³å¯

- æä¾› CMake ç›®æ ‡å˜é‡ï¼ˆå¯¼å…¥ `opcua` ç›®æ ‡ï¼‰
- æä¾› `find_package` æœç´¢çš„ç»“æœå’ŒçŠ¶æ€

opcuaConfig.cmake



```
# ----------------------------------------------------------------------------
#  opcua CMake é…ç½®æ–‡ä»¶
#
#  åŸºæœ¬ç”¨æ³•ï¼š
#    find_package(opcua REQUIRED)
#    target_link_libraries(your_target PRIVATE opcua)
# ----------------------------------------------------------------------------

if(NOT TARGET opcua)
  include(${CMAKE_CURRENT_LIST_DIR}/opcuaTarget.cmake)
endif()

include(FindPackageHandleStandardArgs)
find_package_handle_standard_args(opcua)
```

## [3. äº¤å‰ç¼–è¯‘é¡¹ç›®](https://www.cccolt.top/tutorial/cmake/11.html#_3-äº¤å‰ç¼–è¯‘é¡¹ç›®)

CPU æœ‰ä¸åŒçš„æ¶æ„ã€æŒ‡ä»¤é›†ï¼ŒC/C++ å¼€å‘ä¸­çš„ä»£ç ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨ä¸åŒçš„ CPU ä¸Šç›´æ¥è¿è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚å¯¹æ­¤æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

- åœ¨ç›®æ ‡å¹³å°ä¸Šç›´æ¥ç¼–è¯‘ä»£ç ï¼Œä¾‹å¦‚ä¸ºäº†åœ¨ 64 ä½ ARM å¹³å°ä¸Šè¿è¡Œä»£ç ï¼Œå¯ä»¥ç›´æ¥åœ¨ `aarch64` å¹³å°ä¸Šç¼–è¯‘ä»£ç ã€‚ä½†ä¸€èˆ¬æ¥è¯´ï¼ŒARM å¹³å°å¸¸è§äºåµŒå…¥å¼è®¾å¤‡ï¼Œè¿™ç±»è®¾å¤‡å¯èƒ½ç¼ºå°‘ç¼–è¯‘å·¥å…·é“¾ï¼Œåœ¨æ€§èƒ½ä¸Šä¹Ÿéå¸¸æœ‰é™ï¼Œå› æ­¤è¿™ç§æ–¹å¼å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰æƒ…å†µã€‚
- ç›´æ¥åœ¨ PC ä¸Šç¼–è¯‘ç›®æ ‡å¹³å°çš„ä»£ç ï¼Œç„¶åå°†ç¼–è¯‘å¥½çš„ä»£ç ç§»æ¤ï¼ˆå¤åˆ¶ç²˜è´´ï¼‰åˆ°ç›®æ ‡å¹³å°ä¸Šè¿è¡Œã€‚è¿™ç§æ–¹å¼ç§°ä¸ºäº¤å‰ç¼–è¯‘ï¼Œåœ¨åµŒå…¥å¼ Linux å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œä¾‹å¦‚åœ¨ `amd64` å¹³å°ä¸Šç¼–è¯‘ ARM å¹³å°çš„ä»£ç ã€‚

### [3.1 å·¥å…·é“¾æ–‡ä»¶çš„ç¼–å†™](https://www.cccolt.top/tutorial/cmake/11.html#_3-1-å·¥å…·é“¾æ–‡ä»¶çš„ç¼–å†™)

CMake æä¾›äº†å¼ºå¤§çš„äº¤å‰ç¼–è¯‘æ”¯æŒï¼Œè€Œä¸”ä»…éœ€ä¸€ä¸ªå·¥å…·é“¾æ–‡ä»¶å³å¯å®Œæˆäº¤å‰ç¼–è¯‘çš„å·¥ä½œã€‚å·¥å…·é“¾æ–‡ä»¶æ˜¯ä¸€ä¸ª CMake è„šæœ¬ï¼Œç”¨äºæŒ‡å®šäº¤å‰ç¼–è¯‘çš„å·¥å…·é“¾ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨ã€é“¾æ¥å™¨ã€åº“æ–‡ä»¶è·¯å¾„ç­‰ã€‚å·¥å…·é“¾æ–‡ä»¶æ²¡æœ‰ä¸¥æ ¼çš„å‘½åè§„åˆ™ï¼Œå°±å¦‚åŒæ™®é€šçš„ `*.cmake` æ–‡ä»¶ä¸€æ ·ï¼Œä¸è¿‡ä¸€èˆ¬ä¹ æƒ¯ä¸Šä¼šåœ¨å·¥å…·é“¾æ–‡ä»¶çš„åå­—ä¸­æåˆ°å¹³å°æˆ– `toolchain` å­—æ ·ï¼Œåœ¨ CMake é…ç½®è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ `-DCMAKE_TOOLCHAIN_FILE` é€‰é¡¹æŒ‡å®šå·¥å…·é“¾æ–‡ä»¶ï¼Œä¾‹å¦‚



```
cmake -DCMAKE_TOOLCHAIN_FILE=toolchain-aarch64.cmake ..
```

ä¸€èˆ¬æ¥è¯´ï¼Œå·¥å…·é“¾æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š



```
# æŒ‡å®šç›®æ ‡ç³»ç»Ÿ
set(CMAKE_SYSTEM_NAME Linux)
# æŒ‡å®šç›®æ ‡å¤„ç†å™¨æ¶æ„
set(CMAKE_SYSTEM_PROCESSOR aarch64)

# æŒ‡å®šç›®æ ‡ç³»ç»Ÿçš„æ ¹ç›®å½•ï¼Œå°†ç›´æ¥å½±å“ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨çš„è¡Œä¸º
set(CMAKE_SYSROOT "/path/to/sysroot")

# æŒ‡å®š C äº¤å‰ç¼–è¯‘å™¨
set(CMAKE_C_COMPILER "/path/to/arm-gcc")
# æŒ‡å®š C++ äº¤å‰ç¼–è¯‘å™¨
set(CMAKE_CXX_COMPILER "/path/to/arm-g++")

# æŒ‡å®š CMake æŸ¥æ‰¾æ–‡ä»¶çš„è·¯å¾„ï¼Œä¾‹å¦‚ find_package
set(CMAKE_FIND_ROOT_PATH "/path/to/sysroot")
# ä¸æŸ¥æ‰¾ç¨‹åº
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
# åªæŸ¥æ‰¾åº“
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
# åªæŸ¥æ‰¾å¤´æ–‡ä»¶
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
```

### [3.2 é¢„æœŸç›®æ ‡](https://www.cccolt.top/tutorial/cmake/11.html#_3-2-é¢„æœŸç›®æ ‡)

ç°è®¡åˆ’å¼€å‘ä¸€ä¸ª EtherCAT åè®®çš„æœºæ¢°è‡‚é©±åŠ¨ç¨‹åº `ec_robot`ï¼Œè¯¥ç¨‹åºéœ€è¦åœ¨ aarch64 æ¶æ„çš„ Linux å¹³å°ä¸‹è¿è¡Œï¼Œ`ec_robot` é¡¹ç›®çš„å¼€å‘éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. éœ€è¦ä½¿ç”¨æŒ‡å®šçš„å·¥å…·é“¾è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œç›®æ ‡ç³»ç»Ÿæ ¹ç›®å½•å‡è®¾åœ¨ `/home/ecdev/buildroot/host/` ä¸‹

   - C äº¤å‰ç¼–è¯‘å™¨ä¸º `aarch64-linux-gnu-gcc`ï¼Œä½äºç›®æ ‡ç³»ç»Ÿæ ¹ç›®å½•çš„ `/usr/bin` ç›®å½•ä¸‹ï¼›
   - C++ äº¤å‰ç¼–è¯‘å™¨ä¸º `aarch64-linux-gnu-g++`ï¼Œä½äºç›®æ ‡ç³»ç»Ÿæ ¹ç›®å½•çš„ `/usr/bin` ç›®å½•ä¸‹ï¼›

2. éœ€è¦æ”¯æŒ C++17 æ ‡å‡†ï¼›

3. å¼ºåˆ¶ä¾èµ– IgH å®ç°çš„ `EtherCAT` ä¸»ç«™é©±åŠ¨åº“ï¼Œå¯¹åº”çš„é…ç½®æ–‡ä»¶åœ¨ `/home/ecdev/buildroot/host/usr/lib/cmake/ethercat` ä¸‹ï¼Œå¯¹åº”çš„ç›®æ ‡åä¸º `EtherLab::EtherCAT`ï¼›

4. `ec_robot` é¡¹ç›®æ— éœ€å®‰è£…ï¼Œåªéœ€æ„å»ºå³å¯ã€‚

5. æ²¡æœ‰å¤æ‚çš„æ–‡ä»¶ç»“æ„ï¼Œæœ¬é¡¹ç›®åªæœ‰ä¸€ä¸ª `src` ç›®å½•ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

   

   ```
   .
   â””â”€â”€ src
       â”œâ”€â”€ ec_robot.cpp
       â”œâ”€â”€ ec_robot.hpp
       â””â”€â”€ main.cpp
   ```

### [3.3 åˆ†æ](https://www.cccolt.top/tutorial/cmake/11.html#_3-3-åˆ†æ)

- éœ€è¦å®ç°ä¸€ä¸ªå·¥å…·é“¾æ–‡ä»¶ `toolchain-aarch64.cmake`ï¼Œç”¨äºæŒ‡å®šäº¤å‰ç¼–è¯‘çš„å·¥å…·é“¾ï¼›
- `EtherCATConfig.cmake` æ–‡ä»¶åœ¨ `find_package` çš„ Config æ¨¡å¼èƒ½å¤Ÿç›´æ¥æ‰¾åˆ°çš„ä½ç½®ï¼Œå‰ææ˜¯å·¥å…·é“¾æ–‡ä»¶ä¸­çš„ `CMAKE_FIND_ROOT_PATH` è®¾ç½®æ­£ç¡®ï¼›
- é¡¹ç›®é™¤äº†å·¥å…·é“¾æ–‡ä»¶å¤–ï¼Œåªéœ€è¦ä¸€ä¸ª `CMakeLists.txt` æ–‡ä»¶ï¼Œå¹¶ä¸”æ„å»ºæ–¹å¼å’Œæ™®é€šé¡¹ç›®ä¸€æ ·ã€‚

### [3.4 å®ç°](https://www.cccolt.top/tutorial/cmake/11.html#_3-4-å®ç°)

åœ¨é¡¹ç›®ä¸­æ·»åŠ 

- `platform/toolchain-aarch64.cmake` â€”â€” äº¤å‰ç¼–è¯‘å·¥å…·é“¾æ–‡ä»¶
- `CMakeLists.txt` â€”â€” é¡¹ç›®æ ¹ç›®å½•çš„ CMake é…ç½®æ–‡ä»¶

å…± 2 ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸‹æ–‡ä»¶ç»“æ„æ‰€ç¤º



```
.
â”œâ”€â”€ CMakeLists.txt              (New)
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ ec_robot.cpp
â”‚   â”œâ”€â”€ ec_robot.hpp
â”‚   â””â”€â”€ main.cpp
â””â”€â”€ platform
    â””â”€â”€ toolchain-aarch64.cmake (New)
```

CMakeLists.txtplatform/toolchain-aarch64.cmake



```
cmake_minimum_required(VERSION 3.16)

project(ec_robot)

set(CMAKE_CXX_STANDARD 17)

find_package(EtherCAT REQUIRED)

aux_source_directory(src target_src)
add_executable(ec_robot ${target_src})

target_link_libraries(ec_robot
  PRIVATE EtherLab::EtherCAT
)
```

ä¸è¦æƒŠè®¶ä¸ºä»€ä¹ˆ `CMakeLists.txt` ä¸­æ²¡æœ‰å¼•ç”¨å·¥å…·é“¾æ–‡ä»¶ï¼Œå› ä¸ºä¹ æƒ¯ä¸Šä¼šåœ¨ CMake æ‰§è¡Œé…ç½®ç”Ÿæˆè¿‡ç¨‹æ—¶å†æŒ‡å®šå·¥å…·é“¾æ–‡ä»¶ã€‚

æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•ï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ



```
mkdir build
cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=platform/toolchain-aarch64.cmake
cmake --build build
```

å³å¯å®Œæˆç¼–è¯‘ã€‚å¯èƒ½æœ‰éƒ¨åˆ†è¯»è€…æ²¡æœ‰è§è¿‡ `-B` å’Œ `-S` é€‰é¡¹ï¼Œè¿™æ˜¯ CMake 3.13 ç‰ˆæœ¬å¼•å…¥çš„[åŠŸèƒ½](https://cmake.org/cmake/help/latest/manual/cmake.1.html#options)ã€‚`-B` é€‰é¡¹ç”¨äºæŒ‡å®šæ„å»ºç›®å½•ï¼Œ`-S` é€‰é¡¹ç”¨äºæŒ‡å®šæºç ç›®å½•ï¼Œè¿™æ ·å¯ä»¥å°†æ„å»ºç›®å½•å’Œæºç ç›®å½•åˆ†å¼€ï¼Œé¿å…åœ¨æºç ç›®å½•ä¸­ç”Ÿæˆæ„å»ºæ–‡ä»¶ã€‚

ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨ `build` ç›®å½•ä¸‹ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶åˆ°ç›®æ ‡å¹³å°ä¸Šè¿è¡Œï¼Œä¾‹å¦‚å¯ä»¥ä½¿ç”¨ SSH å·¥å…·çš„ `scp` å‘½ä»¤å°†æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡å¹³å°ä¸Šï¼Œä½†è¦ç¡®ä¿ç›®æ ‡å¹³å°æœ‰ `libethercat.so` çš„åº“æ–‡ä»¶ï¼Œå¹¶ä¸”ä¿è¯å¤åˆ¶åçš„å¯æ‰§è¡Œæ–‡ä»¶èƒ½å¤Ÿæ‰¾åˆ°ã€‚

## [4. è·¨å¹³å°é¡¹ç›®](https://www.cccolt.top/tutorial/cmake/11.html#_4-è·¨å¹³å°é¡¹ç›®)

äº¤å‰ç¼–è¯‘é¡¹ç›®è™½ç„¶æ¶‰åŠåˆ°ä¸åŒçš„å¹³å°ï¼Œä½†æ˜¯åªéœ€è¦ä¸€ä¸ªå·¥å…·é“¾æ–‡ä»¶å³å¯ï¼Œå› ä¸ºå¤§éƒ¨åˆ†äº¤å‰ç¼–è¯‘é¡¹ç›®éƒ½åªæ¶‰åŠ Linux å†…æ ¸ï¼Œåªä¸è¿‡æ¶‰åŠåˆ°ä¸åŒçš„ CPU æ¶æ„ã€OSã€æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œè·¨å¹³å°é¡¹ç›®åˆ™éœ€è¦è€ƒè™‘ä¸åŒå¹³å°çš„å·®å¼‚ï¼Œä¾‹å¦‚ Windows å’Œ Linux ä¸¤ä¸ªå¹³å°çš„å·®å¼‚å°±éå¸¸å¤§ã€‚

è·¨å¹³å°æ˜¯é¡¹ç›®å¼€å‘çš„ä¸€ä¸ªé‡è¦æ–¹å‘ï¼ŒæŒ‰ç…§ ISO æ ‡å‡†ç¼–å†™çš„ C++ ç¨‹åºè·¨å¹³å°æ€§è¾ƒå¥½ï¼Œä½†æ˜¯åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¾€å¾€ä¼šä½¿ç”¨ä¸€äº›å¹³å°ç›¸å…³æˆ–è€…æ˜¯ç¼–è¯‘å™¨ç›¸å…³çš„ APIï¼Œè¿™å°±å¯¼è‡´äº†è·¨å¹³å°çš„å›°éš¾ã€‚ä½¿ç”¨ CMake å®Œæˆè·¨å¹³å°é¡¹ç›®çš„å¼€å‘æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼ŒCMake æä¾›äº†å¾ˆå¤šå·¥å…·å’Œå‡½æ•°ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…æ›´å¥½çš„å®ç°è·¨å¹³å°é¡¹ç›®ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè·¨å¹³å°é¡¹ç›®çš„å¼€å‘éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- ç¼–è¯‘å™¨çš„ç¼–è¯‘é€‰é¡¹ä¸åŒï¼Œä¾‹å¦‚ç”¨äºæ§åˆ¶ C++ è¯­è¨€æ ‡å‡†çš„é€‰é¡¹ï¼Œåœ¨ GCC ä¸­æ˜¯ `-std=c++<ver>`ï¼Œåœ¨ MSVC ä¸­æ˜¯ `/std:c++<ver>`ï¼›

  é‡è¦

  ä¸è¿‡åœ¨ CMake ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `CMAKE_CXX_STANDARD` å˜é‡æ¥æŒ‡å®š C++ æ ‡å‡†ï¼ŒCMake ä¼šæ ¹æ®ä¸åŒçš„ç¼–è¯‘å™¨è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„ç¼–è¯‘é€‰é¡¹ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ã€‚

- ä¸åŒå¹³å°çš„åº“æ–‡ä»¶åç¼€åä¸åŒï¼Œä¾‹å¦‚ Windows ä¸‹çš„é™æ€åº“æ–‡ä»¶åç¼€åæ˜¯ `*.lib`ï¼ŒLinux ä¸‹çš„é™æ€åº“æ–‡ä»¶åç¼€åæ˜¯ `*.a`ï¼Œå¹¶ä¸”åº“æ–‡ä»¶çš„ç»„ç»‡æ–¹å¼ä¹Ÿä¸åŒï¼ŒWindows ä¸‹åœ¨é“¾æ¥åŠ¨æ€åº“æ—¶éœ€è¦ä½¿ç”¨å¯¼å…¥åº“ `*.lib`ï¼ŒLinux ä¸‹åœ¨é“¾æ¥åŠ¨æ€åº“æ—¶åˆ™ç›´æ¥ä½¿ç”¨åŠ¨æ€åº“ `*.so`ã€‚

- é»˜è®¤å®‰è£…è·¯å¾„ä¸åŒï¼ŒWindows ä¸‹çš„é»˜è®¤å®‰è£…è·¯å¾„æ˜¯ `C:\Program Files`ï¼ŒLinux ä¸‹çš„é»˜è®¤å®‰è£…è·¯å¾„æ˜¯ `/usr/local`ï¼Œä½† Windows ä¸å»ºè®®ç›´æ¥å®‰è£…åˆ° `C:\Program Files`ï¼Œè€Œ Linux åˆ™æ²¡æœ‰è¿‡å¤šçš„é™åˆ¶ã€‚

### [4.1 é¢„æœŸç›®æ ‡](https://www.cccolt.top/tutorial/cmake/11.html#_4-1-é¢„æœŸç›®æ ‡)

ç°è®¡åˆ’å¼€å‘ä¸€ä¸ªè·¨å¹³å°çš„åŸºç¡€æ•°å€¼ç®—æ³•å’Œæœ€ä¼˜åŒ–åº“ `numopt`ï¼Œè¯¥åº“éœ€è¦æ”¯æŒ Windows å’Œ Linux ä¸¤ä¸ªå¹³å°ï¼Œ`numopt` é¡¹ç›®çš„å¼€å‘éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. éœ€è¦æ”¯æŒ C++17 æ ‡å‡†ï¼›

2. é»˜è®¤ä»¥é™æ€åº“çš„å½¢å¼æ„å»º `numopt`ï¼Œä½†å…è®¸ç”¨æˆ·é€šè¿‡ CMake é€‰é¡¹è®¾ç½®æ„å»ºä¸ºåŠ¨æ€åº“ï¼›

3. åº“åŒ…å«äº† `core`ã€`num` å’Œ `opt` 3 ä¸ªæ¨¡å—å’Œ `numopt_version` 1 ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…¶ä¸­ `num` å’Œ `opt` ä¾èµ– `core` æ¨¡å—ï¼Œ`numopt_version` ä¾èµ– `core` æ¨¡å—ï¼›

4. `numopt` é¡¹ç›®çš„é»˜è®¤å®‰è£…ç›®å½•å¦‚ä¸‹

   |      å†…å®¹      |                Window å®‰è£…è·¯å¾„                |        Linux å®‰è£…è·¯å¾„        |
   | :------------: | :-------------------------------------------: | :--------------------------: |
   |   é¡¹ç›®æ ¹ç›®å½•   | `${CMAKE_BINARY_DIR}/install` è®°ä½œ `<prefix>` | `/usr/local` è®°ä½œ `<prefix>` |
   |     å¤´æ–‡ä»¶     |              `<prefix>\include`               |  `<prefix>/include/numopt`   |
   |   å¯æ‰§è¡Œæ–‡ä»¶   |            `<prefix>\x64\vc16\bin`            |        `<prefix>/bin`        |
   |   é™æ€åº“æ–‡ä»¶   |            `<prefix>\x64\vc16\lib`            |        `<prefix>/lib`        |
   |   åŠ¨æ€åº“æ–‡ä»¶   |            `<prefix>\x64\vc16\bin`            |        `<prefix>/lib`        |
   |   å¯¼å…¥åº“æ–‡ä»¶   |            `<prefix>\x64\vc16\lib`            |              â€”â€”              |
   | CMake é…ç½®æ–‡ä»¶ |            `<prefix>\x64\vc16\lib`            | `<prefix>/lib/cmake/numopt`  |

5. éœ€è¦æä¾› `uninstall` ç›®æ ‡ï¼Œç”¨äºå¸è½½å·²å®‰è£…çš„æ–‡ä»¶ï¼Œåœ¨æ‰§è¡Œ

   

   ```
   cmake --build . --target uninstall
   ```

   åï¼Œå®‰è£…ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½ä¼šè¢«åˆ é™¤ã€‚

æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š



```
.
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ core
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ num
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ opt
â”‚       â”œâ”€â”€ include
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ src
â”‚           â””â”€â”€ ...
â””â”€â”€ samples
    â””â”€â”€ version.cpp
```

### [4.2 å®ç°](https://www.cccolt.top/tutorial/cmake/11.html#_4-2-å®ç°)

åœ¨é¡¹ç›®æ„å»ºéƒ¨åˆ†å’Œ[å¸¸è§„éè·¨å¹³å°é¡¹ç›®](https://www.cccolt.top/tutorial/cmake/11.html#_1-å¸¸è§„éè·¨å¹³å°é¡¹ç›®)ä¸€è‡´ï¼Œåªæ˜¯åœ¨å®‰è£…éƒ¨åˆ†éœ€è¦è€ƒè™‘ä¸åŒå¹³å°çš„å·®å¼‚ï¼Œå› æ­¤è·¨å¹³å°é¡¹ç›®åªæ˜¯æ¯”å¸¸è§„é¡¹ç›®å¤šäº†ä¸€äº›å¹³å°ç›¸å…³çš„é…ç½®ã€‚

å’Œå¸¸è§„éè·¨å¹³å°é¡¹ç›®ä¸€æ ·ï¼Œåœ¨é¡¹ç›®ä¸­æ·»åŠ 

- `modules/core/CMakeLists.txt` â€”â€” `core` æ¨¡å—çš„ CMake é…ç½®æ–‡ä»¶
- `modules/num/CMakeLists.txt` â€”â€” `num` æ¨¡å—çš„ CMake é…ç½®æ–‡ä»¶
- `modules/opt/CMakeLists.txt` â€”â€” `opt` æ¨¡å—çš„ CMake é…ç½®æ–‡ä»¶
- `modules/CMakelists.txt` â€”â€” é¡¹ç›®çš„æ¨¡å—åˆ—è¡¨
- `samples/CMakeLists.txt` â€”â€” ç¤ºä¾‹ç¨‹åºçš„ CMake é…ç½®æ–‡ä»¶
- `CMakeLists.txt` â€”â€” é¡¹ç›®æ ¹ç›®å½•çš„ CMake é…ç½®æ–‡ä»¶
- `cmake/numoptInstall.cmake` â€”â€” ä¸é¡¹ç›®å®‰è£…è·¯å¾„ç›¸å…³çš„é…ç½®æ–‡ä»¶
- `cmake/templates/numoptConfig.cmake.in` â€”â€” é¡¹ç›®çš„ CMake é…ç½®æ–‡ä»¶çš„æ¨¡æ¿æ–‡ä»¶
- `cmake/templates/cmake_uninstall.cmake.in` â€”â€” è‡ªå®šä¹‰å¸è½½ç›®æ ‡çš„æ¨¡æ¿æ–‡ä»¶

å…± 7 ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸‹æ–‡ä»¶ç»“æ„æ‰€ç¤º



```
.
â”œâ”€â”€ CMakeLists.txt                   (New)
â”œâ”€â”€ cmake
â”‚   â”œâ”€â”€ numoptInstall.cmake          (New)
â”‚   â””â”€â”€ templates
â”‚       â”œâ”€â”€ cmake_uninstall.cmake.in (New)
â”‚       â””â”€â”€ numoptConfig.cmake.in    (New)
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ core
â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt           (New)
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ num
â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt           (New)
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ opt
â”‚   â”‚   â”œâ”€â”€ CMakeLists.txt           (New)
â”‚   â”‚   â”œâ”€â”€ include
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ src
â”‚   â”‚       â””â”€â”€ ...
â”‚   â””â”€â”€ CMakeLists.txt               (New)
â””â”€â”€ samples
    â”œâ”€â”€ CMakeLists.txt               (New)
    â””â”€â”€ version.cpp
```

æ–¹ä¾¿èµ·è§ï¼Œå°±ä¸æ·»åŠ ç±»ä¼¼äº `vl_add_module` å’Œ `vl_add_exe` çš„å®äº†ã€‚

#### [4.2.1 é¡¹ç›®é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_4-2-1-é¡¹ç›®é…ç½®)

CMakeLists.txtcmake/numoptInstall.cmake



```
# ----------------------------------------------------------------------------
#   é¡¹ç›®é…ç½®
# ----------------------------------------------------------------------------
cmake_minimum_required(VERSION 3.16)

project(
  numopt
  LANGUAGES CXX
)

set(CMAKE_CXX_STANDARD 17)

option(BUILD_SHARED_LIBS "Build shared libraries?" OFF)

include(cmake/numoptInstall.cmake)

# ----------------------------------------------------------------------------
#   ç›®æ ‡æ„å»º
# ----------------------------------------------------------------------------
# main target
add_subdirectory(modules)

# executable target
add_subdirectory(samples)

# uninstall target
if(NOT TARGET uninstall)
  configure_file(
    "${CMAKE_CURRENT_SOURCE_DIR}/cmake/templates/cmake_uninstall.cmake.in"
    "${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake"
    IMMEDIATE @ONLY
  )

  add_custom_target(uninstall
    COMMAND ${CMAKE_COMMAND} -P ${CMAKE_CURRENT_BINARY_DIR}/cmake_uninstall.cmake
  )
endif()

# ----------------------------------------------------------------------------
#   å¯¼å‡ºã€å®‰è£…
# ----------------------------------------------------------------------------
install(
  EXPORT numoptModules
  DESTINATION ${NUMOPT_CFG_INSTALL_PATH}
  FILE numoptModules.cmake
)

file(RELATIVE_PATH NUMOPT_INSTALL_RELATIVE_PATH 
  "${CMAKE_INSTALL_PREFIX}/${NUMOPT_CFG_INSTALL_PATH}/" ${CMAKE_INSTALL_PREFIX})

configure_file(
  cmake/numoptConfig.cmake.in
  "${CMAKE_CURRENT_BINARY_DIR}/numoptConfig.cmake"
  @ONLY
)

install(
  FILES "${CMAKE_CURRENT_BINARY_DIR}/numoptConfig.cmake"
  DESTINATION ${NUMOPT_CFG_INSTALL_PATH}
)
```

#### [4.2.2 æ¨¡å—é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_4-2-2-æ¨¡å—é…ç½®)

`modules` ç›®å½•ä¸‹çš„ `CMakeLists.txt` å’Œå„ä¸ªæ¨¡å—çš„ `CMakeLists.txt` æ–‡ä»¶å¦‚ä¸‹ï¼š

modules`core` æ¨¡å—`num` æ¨¡å—`opt` æ¨¡å—



```
add_subdirectory(core)
add_subdirectory(num)
add_subdirectory(opt)
```

æç¤º

ç”±äºæ²¡æœ‰ä½¿ç”¨å®ï¼Œ`core` æ¨¡å—ã€`num` æ¨¡å—å’Œ `opt` æ¨¡å—çš„é…ç½®å†™äº†å¤§é‡çš„é‡å¤ä»£ç ï¼Œå¯è¯»æ€§é™ä½ã€‚å› æ­¤åœ¨å¿…è¦æ—¶å€™ä½¿ç”¨å®æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚è¿™é‡Œå°±ä¸å†å±•ç¤ºå®çš„ä½¿ç”¨ï¼Œè¯»è€…å¯ä»¥æŒ‰ç…§[å¸¸è§„éè·¨å¹³å°é¡¹ç›®é…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_1-4-1-é¡¹ç›®é…ç½®)ä¸­çš„å†…å®¹è‡ªè¡Œæ·»åŠ å®ã€‚

#### [4.2.3 ç¤ºä¾‹ç¨‹åºé…ç½®](https://www.cccolt.top/tutorial/cmake/11.html#_4-2-3-ç¤ºä¾‹ç¨‹åºé…ç½®)

samples/CMakeLists.txt



```
add_executable(numopt_version version.cpp)

target_link_libraries(numopt_version PRIVATE core)
```

#### [4.2.4 CMake é…ç½®æ–‡ä»¶æ¨¡æ¿](https://www.cccolt.top/tutorial/cmake/11.html#_4-2-4-cmake-é…ç½®æ–‡ä»¶æ¨¡æ¿)

`cmake_uninstall.cmake.in` æ–‡ä»¶å‚è€ƒè‡ª[æ­¤å¤„](https://gitlab.kitware.com/cmake/community/-/wikis/FAQ#can-i-do-make-uninstall-with-cmake)ï¼Œç”¨æˆ·åœ¨å®é™…ä½¿ç”¨æ—¶æœ€å¥½åŠ ä¸Šå‡ºå¤„ã€‚

numoptConfig.cmake.incmake_uninstall.cmake.in



```
# ----------------------------------------------------------------------------
#  numopt CMake é…ç½®æ–‡ä»¶
#
#                  ** è¯¥æ–‡ä»¶ç”± CMake ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ **
#
#  åŸºæœ¬ç”¨æ³•ï¼š
#    find_package(numopt REQUIRED)
#    target_link_libraries(your_target PRIVATE ${numopt_LIBS})
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
#   è·å– numopt å®‰è£…è·¯å¾„
# ----------------------------------------------------------------------------
get_filename_component(NUMOPT_CONFIG_PATH "${CMAKE_CURRENT_LIST_FILE}" PATH)
get_filename_component(NUMOPT_INSTALL_PATH
  "${NUMOPT_CONFIG_PATH}/@NUMOPT_INSTALL_RELATIVE_PATH@" REALPATH
)

# ----------------------------------------------------------------------------
#   è®¾ç½®å¤´æ–‡ä»¶æœç´¢è·¯å¾„å˜é‡
# ----------------------------------------------------------------------------
set(numopt_INCLUDE_DIRS "${NUMOPT_INSTALL_PATH}/@NUMOPT_INC_INSTALL_PATH@")

# ----------------------------------------------------------------------------
#   è®¾ç½®åº“æ–‡ä»¶è·¯å¾„å˜é‡
# ----------------------------------------------------------------------------
set(numopt_LIBS @NUMOPT_LIB_COMPONENTS@)

if(NOT TARGET core)
  include("${NUMOPT_CONFIG_PATH}/numoptModules.cmake")
endif()

# ----------------------------------------------------------------------------
#   æœå¯»çš„ç»“æœã€çŠ¶æ€
# ----------------------------------------------------------------------------
include(FindPackageHandleStandardArgs)

find_package_handle_standard_args(numopt
  REQUIRED_VARS numopt_INSTALL_PATH
)
```

### [4.3 é’ˆå¯¹ Visual Studio çš„ç‰¹æ®Šè®¾è®¡](https://www.cccolt.top/tutorial/cmake/11.html#_4-3-é’ˆå¯¹-visual-studio-çš„ç‰¹æ®Šè®¾è®¡)

å¯¹äºå¤šä¸ªç›®æ ‡çš„é¡¹ç›®ï¼Œä¼šç”Ÿæˆå¤šä¸ªåº“æ–‡ä»¶ï¼Œä¾‹å¦‚æœ¬ `numopt` é¡¹ç›®ï¼Œåœ¨ Windows ä¸‹ä¼šç”Ÿæˆ `core.lib`ã€`num.lib` å’Œ `opt.lib` 3 ä¸ªåº“æ–‡ä»¶ï¼Œåœ¨ Visual Studio ä¸­ï¼Œåˆ©ç”¨è¿™ 3 ä¸ªåº“æ–‡ä»¶è¿›è¡Œå¼€å‘ï¼Œéœ€è¦å†é¡¹ç›®ä¸­æ‰‹åŠ¨æ·»åŠ ï¼Œè¿™æ ·ä¼šå¢åŠ å¼€å‘è€…çš„å·¥ä½œé‡ã€‚ä¸ºäº†ç®€åŒ–å¼€å‘è€…çš„å·¥ä½œï¼Œå¯ä»¥å°†è¿™ 3 ä¸ªåº“æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª `numopt_world.lib` æ–‡ä»¶ï¼Œè¿™æ ·å¼€å‘è€…åªéœ€è¦æ·»åŠ ä¸€ä¸ªåº“æ–‡ä»¶å³å¯ã€‚

ä¾‹å¦‚ OpenCV åŸå…ˆä¼šç”Ÿæˆ `opencv_core.lib`ã€`opencv_imgproc.lib` ä»¥åŠ `opencv_highgui.lib` ç­‰å¯¼å…¥åº“æ–‡ä»¶ï¼Œåœ¨å¯ç”¨ `BUILD_opencv_world` é€‰é¡¹åï¼Œåˆ™ä¸å†ç”ŸæˆåŸå…ˆçš„åº“æ–‡ä»¶ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä¸ª `opencv_world.lib` å¯¼å…¥åº“æ–‡ä»¶ã€‚è¿™æ—¶å¼€å‘è€…åœ¨ä½¿ç”¨ Visual Studio å¯¹é¡¹ç›®çš„å¯¼å…¥åº“è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œåªéœ€æ·»åŠ  `opencv_world.lib` è¯¥å¯¼å…¥åº“æ–‡ä»¶çš„è·¯å¾„å’Œåå­—å³å¯ã€‚

ä¸€ä¸ªç®€å•çš„å®ç°æ–¹å¼æ˜¯åœ¨ `core`ã€`num` å’Œ `opt` æ¨¡å—çš„ `CMakeLists.txt` æ–‡ä»¶ä¸­æ·»åŠ åˆ¤æ–­ï¼Œä¸‹é¢ä»¥ `core` æ¨¡å—ä¸ºä¾‹ï¼š



```
if(NOT BUILD_WORLD)
  # åŸå…ˆçš„é…ç½®
else()
  aux source_directory(src core_src)
  set(NUMOPT_SRC "${NUMOPT_SRCS} ${core_src}" CACHE INTERNAL "")
  set(NUMOPT_INC "${NUMOPT_INC} ${CMAKE_CURRENT_SOURCE_DIR}/include" CACHE INTERNAL "")
  # ç”±äºæ²¡æœ‰å¤–éƒ¨ä¾èµ–åº“ï¼Œæ‰€ä»¥å°±ä¸å†™ NUMOPT_LIB äº†
endif()
```

ä¿®æ”¹é¡¹ç›®çš„æ ¹ç›®å½•çš„ `CMakeLists.txt` æ–‡ä»¶



```
# ...

# ----------------------------------------------------------------------------
#   ç›®æ ‡æ„å»º
# ----------------------------------------------------------------------------
if(BUILD_WORLD)
  set(NUMOPT_SRC "" CACHE INTERNAL "")
  set(NUMOPT_INC "" CACHE INTERNAL "")
  # ç”±äºæ²¡æœ‰å¤–éƒ¨ä¾èµ–åº“ï¼Œæ‰€ä»¥å°±ä¸å†™ NUMOPT_LIB äº†
endif()

add_subdirectory(modules)
add_subdirectory(samples)

if(BUILD_WORLD)
  add_library(numopt_world ${NUMOPT_SRC})
  target_include_directories(numopt_world PUBLIC
    $<BUILD_INTERFACE:${NUMOPT_INC}>
    $<INSTALL_INTERFACE:${NUMOPT_INC_INSTALL_PATH}>
  )
endif()

# ...
```

è¿˜æœ‰ä¸€ç§å®ç°æ–¹å¼æ˜¯ä½¿ç”¨[å¯¹è±¡åº“](https://www.cccolt.top/tutorial/cmake/05.html#_3-1-1-å¯¹è±¡åº“)ï¼Œå°† `core`ã€`num` å’Œ `opt` æ¨¡å—çš„æºæ–‡ä»¶ç¼–è¯‘æˆå¯¹è±¡æ–‡ä»¶ï¼Œç„¶åå†å°†è¿™äº›å¯¹è±¡æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªåº“æ–‡ä»¶ã€‚ä¾‹å¦‚



```
add_library(core_obj OBJECT ${core_src})
```

å¼€å‘è€…å¯ä»¥è‡ªè¡Œå¢åŠ  `if` åˆ¤æ–­ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥é€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼ã€‚

ä½¿ç”¨å½¢å¦‚ä»¥ä¸‹çš„ä»£ç æ¥å®‰è£…ï¼š

`core` æ¨¡å—`num` æ¨¡å—`opt` æ¨¡å—



```
add_library(core_obj OBJECT ${core_src})

install(TARGETS core_obj
  EXPORT numoptModules
)
```

ä¸è¿‡ï¼Œå¯¹è±¡åº“ç­‰æ•ˆäºå®‰è£…ä¸€ä¸ªæ¥å£åº“ï¼Œå®‰è£…æ¥å£åº“çš„æ•ˆæœå¯ä»¥å‚è€ƒ[ã€10ã€‘é¡¹ç›®çš„å¯¼å‡ºä¸å®‰è£… - æ€è€ƒ](https://www.cccolt.top/tutorial/cmake/10.html#æ€è€ƒ)ä¸­çš„ç¬¬ 2 ä¸ªé—®é¢˜ï¼Œå› æ­¤åœ¨å¯¼å‡ºé…ç½®æ–‡ä»¶ä¸­ä¹Ÿå…·æœ‰ç›¸åº”çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ `numoptModules.cmake` å¯¼å‡ºé…ç½®æ–‡ä»¶ä¸­ä¼šåŒ…å«å¤§è‡´å¦‚ä¸‹å†…å®¹



```
# Create imported target core_obj
add_library(core_obj INTERFACE IMPORTED)

# Create imported target num_obj
add_library(num_obj INTERFACE IMPORTED)

# Create imported target opt_obj
add_library(opt_obj INTERFACE IMPORTED)
```

æ³¨æ„

å¦‚æœå¸Œæœ›åœ¨ `numoptModules.cmake` å¯¼å‡ºé…ç½®æ–‡ä»¶ä¸­åªåŒ…å«ä¸€ä¸ª `numopt_world` ç›®æ ‡è€Œä¸åŒ…å« `core_obj` ç­‰ç”±å¯¹è±¡åº“å¯¼å‡ºç”Ÿæˆçš„æ¥å£åº“ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆã€‚

## [å†™åœ¨åé¢](https://www.cccolt.top/tutorial/cmake/11.html#å†™åœ¨åé¢)

æœ‰å…³ CMake é¡¹ç›®å®æˆ˜çš„å†…å®¹å¯ä»¥å‚è€ƒ [RMVL](https://github.com/cv-rmvl/rmvl.git)[[2\]](https://www.cccolt.top/tutorial/cmake/11.html#footnote2) é¡¹ç›®çš„ CMake æ¡†æ¶ï¼Œæœ¬æ–‡æ¶‰åŠåˆ°çš„

- å¸¸è§„ç›®æ ‡æ„å»ºçš„å†…å®¹
- å¤–éƒ¨ä¾èµ–ç®¡ç†çš„å†…å®¹
- äº¤å‰ç¼–è¯‘çš„å†…å®¹
- è·¨å¹³å°çš„å†…å®¹

å¯¹åº”çš„ CMake é…ç½®ï¼Œéƒ½èƒ½åœ¨ RMVL é¡¹ç›®ä¸­æ‰¾åˆ°ã€‚

1. open62541 developers. [open62541](https://github.com/open62541/open62541.git), September 2014. [â†©ï¸](https://www.cccolt.top/tutorial/cmake/11.html#footnote-ref1)
2. zhaoxi and other RMVL developers. [rmvl](https://github.com/cv-rmvl/rmvl.git), September 2023. [â†©ï¸](https://www.cccolt.top/tutorial/cmake/11.html#footnote-ref2)

